---
import MainLayout from '../../layouts/MainLayout.astro';
import { sql } from '../../lib/db';

const { code } = Astro.params;
const userId = Astro.cookies.get("userId")?.value;

// Use your ID (2) to hide yourself from the leaderboard
const ADMIN_ID = 2; 

if (!userId) return Astro.redirect('/login');

// 1. Get League Info
const leagueInfo = await sql`SELECT id, league_name, invite_code FROM leagues WHERE invite_code = ${code}`;
if (leagueInfo.length === 0) return Astro.redirect('/dashboard');
const league = leagueInfo[0]; 

// 2. Fetch Pre-Calculated Standings
// We join with the users table to get the names
const finalRankings = await sql`
  SELECT 
    u.username, 
    ls.total_score as total
  FROM league_standings ls
  JOIN users u ON ls.user_id = u.id
  WHERE ls.league_id = ${league.id}
    AND u.is_active = true
  ORDER BY ls.total_score DESC
`;

---
<MainLayout title={league.league_name}>
  <div class="max-w-4xl mx-auto py-10 px-4">
    <a href="/dashboard" class="text-[10px] font-black uppercase text-slate-400 hover:text-pink-600 transition-colors">‚Üê Back to Dashboard</a>
    
    <h1 class="text-4xl font-black italic uppercase text-slate-900 mt-2">
       {league.league_name}
    </h1>
    <p class="text-pink-500 font-mono font-bold text-sm mb-10">Invite Code: {league.invite_code}</p>

    <div class="bg-white rounded-[2.5rem] border-2 border-slate-100 shadow-sm overflow-hidden">
      <table class="w-full text-left border-collapse">
        <thead class="bg-slate-50 border-b border-slate-100">
          <tr>
            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest w-20 text-center">Rank</th>
            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Player</th>
            <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest text-right">Score</th>
          </tr>
        </thead>
<tbody>
  {finalRankings.map((player, index) => (
    <tr class={`border-b last:border-none ${player.user_id == userId ? 'bg-pink-50' : ''}`}>
      <td class="p-4 text-center font-black text-slate-300">#{index + 1}</td>
      <td class="p-4 font-black uppercase italic text-slate-800">
        {player.username} {player.user_id == userId && <span class="text-[10px] bg-pink-600 text-white px-2 py-1 rounded ml-2 italic">You</span>}
      </td>
      <td class="p-4 text-right text-xl font-black text-pink-600">
        {parseFloat(player.total).toFixed(1)}
      </td>
    </tr>
  ))}
</tbody>
      </table>
    </div>
  </div>
</MainLayout>