---
import MainLayout from '../../layouts/MainLayout.astro';
import { sql } from '../../lib/db';
import { 
  getSettings, 
  formatMultipliers, 
  recalculateScores, 
  updateSetting, 
  updateSettingsBatch, 
  toggleUserStatus 
} from '../../lib/queries';

// 1. AUTH & SECURITY
const userId = Astro.cookies.get("userId")?.value;
const userRows = await sql`SELECT username FROM users WHERE id = ${userId}`;
const user = userRows[0];

if (!user || user.username !== 'CrewChief') {
  return Astro.redirect('/dashboard');
}

// 2. DATA FETCHING
const settings = await getSettings(); 
const currentEp = parseInt(settings.current_episode || "1");

// UI Helpers for the HTML section
const getSetting = (key) => settings[key] || "1.0";
const isLocked = (ep) => settings[`locked_ep_${ep}`] === 'true';

// 3. POST ACTIONS (The "Delegator")
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");

  // Update Rank Multipliers
  if (action === "update_multipliers") {
    await updateSettingsBatch({
      multiplier_rank_1: formData.get("multiplier_rank_1"),
      multiplier_rank_2: formData.get("multiplier_rank_2"),
      multiplier_rank_3: formData.get("multiplier_rank_3"),
      multiplier_rank_4: formData.get("multiplier_rank_4"),
    });
    return Astro.redirect('/admin');
  }

  // Toggle Player Visibility
  if (action === "toggle_user_status") {
    await toggleUserStatus(
      formData.get("target_id"), 
      formData.get("current_status") === "true"
    );
    return Astro.redirect('/admin');
  }

  // Change Current Active Episode
  if (action === "update_episode") {
    await updateSetting('current_episode', formData.get("current_episode"));
    return Astro.redirect('/admin');
  }

  // Lock/Unlock Roster Submissions
  if (action === "toggle_lock") {
    const ep = formData.get("episode");
    const newState = formData.get("currentState") === 'true' ? 'false' : 'true';
    await updateSetting(`locked_ep_${ep}`, newState);
    return Astro.redirect('/admin');
  }

  // The Big Scoring Engine
  if (action === "recalculate_scores") {
    const mults = formatMultipliers(settings);
    const targetEp = parseInt(formData.get("current_episode") || currentEp);
    await recalculateScores(targetEp, mults);
    return Astro.redirect('/admin?success=recalculated');
  }
}

// 4. FINAL UI DATA
const allUsers = await sql`SELECT id, username, is_active FROM users ORDER BY username ASC`;
---

<MainLayout title="Admin Settings">
  <div class="max-w-4xl mx-auto py-10 px-4">
    <div class="mb-10">
      <h1 class="text-4xl font-black italic uppercase text-slate-900">League Control Center</h1>
      <p class="text-slate-500 font-bold uppercase tracking-widest text-xs text-left">Manage Season Flow & Locks</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      
      <div class="bg-white p-8 rounded-[2.5rem] border-2 border-slate-100 shadow-sm">
        <div class="mb-6">
          <h2 class="text-xl font-black uppercase italic text-slate-800">Global Episode</h2>
          <p class="text-sm text-slate-500">Sets the default week for the entire site.</p>
        </div>
        
        <form method="POST" class="flex items-center gap-4">
          <input type="hidden" name="action" value="update_episode" />
          <input 
            type="number" 
            name="current_episode" 
            value={currentEp} 
            class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black text-2xl text-center focus:ring-2 focus:ring-pink-500"
          />
          <button class="bg-slate-900 text-white font-black px-6 py-4 rounded-2xl uppercase text-xs hover:bg-slate-800 transition-all">
            Update
          </button>
        </form>
      </div>

      <div class="bg-pink-600 p-8 rounded-[2.5rem] text-white shadow-xl shadow-pink-200">
        <h2 class="text-xl font-black uppercase italic mb-2">System Status</h2>
        <div class="space-y-4 mt-6">
          <div class="flex justify-between items-center border-b border-pink-500 pb-2">
            <span class="text-xs font-bold uppercase opacity-80">Drafting Status</span>
            <span class="font-black uppercase">{isLocked(currentEp) ? 'üî¥ Locked' : 'üü¢ Open'}</span>
          </div>
          <div class="flex justify-between items-center border-b border-pink-500 pb-2">
            <span class="text-xs font-bold uppercase opacity-80">Active Week</span>
            <span class="font-black uppercase italic">Episode {currentEp}</span>
          </div>
        </div>
      </div>
<section class="mb-8 p-6 bg-slate-800 rounded-xl border border-purple-500/30 shadow-lg">
  <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
    <span>üõ†Ô∏è</span> Admin Quick Actions
  </h2>
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <a href="/admin/scores" class="flex items-center justify-between p-4 bg-slate-900 rounded-lg border border-slate-700 hover:border-purple-400 transition-colors group">
      <div>
        <div class="font-bold text-purple-400">Enter Queen Scores</div>
        <div class="text-sm text-slate-400">Manually input points for the week</div>
      </div>
      <span class="group-hover:translate-x-1 transition-transform">‚Üí</span>
    </a>

    <a href="/admin/leagues" class="flex items-center justify-between p-4 bg-slate-900 rounded-lg border border-slate-700 hover:border-purple-400 transition-colors group">
      <div>
        <div class="font-bold text-purple-400">Manage Leagues</div>
        <div class="text-sm text-slate-400">View participants and rosters</div>
      </div>
      <span class="group-hover:translate-x-1 transition-transform">‚Üí</span>
    </a>
  </div>
</section>
    </div>




    <div class="mt-12">
      <h2 class="text-2xl font-black uppercase italic text-slate-900 mb-6">Episode Locks</h2>
      <div class="bg-white rounded-[2.5rem] border-2 border-slate-100 overflow-hidden">
        <table class="w-full text-left">
          <thead class="bg-slate-50 border-b border-slate-100">
            <tr>
              <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400">Episode</th>
              <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400">Draft Status</th>
              <th class="px-6 py-4 text-right"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-50">
            {[1,2,3,4,5,6,7,8].map(ep => (
              <tr>
                <td class="px-6 py-4 font-black text-slate-700">Episode {ep}</td>
                <td class="px-6 py-4">
                  <span class={`text-[10px] font-black uppercase px-3 py-1 rounded-full ${isLocked(ep) ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                    {isLocked(ep) ? 'Locked' : 'Open'}
                  </span>
                </td>
                <td class="px-6 py-4 text-right">
                  <form method="POST">
                    <input type="hidden" name="action" value="toggle_lock" />
                    <input type="hidden" name="episode" value={ep} />
                    <input type="hidden" name="currentState" value={isLocked(ep) ? 'true' : 'false'} />
                    <button class="text-[10px] font-black uppercase text-slate-400 hover:text-pink-600 transition-colors">
                      {isLocked(ep) ? 'Unlock' : 'Lock'}
                    </button>
                  </form>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
    <div class="bg-white p-8 rounded-[2rem] border-2 border-slate-100 mt-8">
  <h2 class="text-xl font-black uppercase italic mb-2 text-slate-900">Season Engine</h2>
  <p class="text-slate-500 text-xs mb-6 font-bold uppercase">Update all league leaderboards with the latest points and multipliers.</p>
  
  <form method="POST">
    <input type="hidden" name="action" value="recalculate_scores" />
    <button type="submit" class="w-full bg-pink-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-pink-200 hover:scale-[1.02] active:scale-95 transition-all">
      üîÑ RECALCULATE ALL STANDINGS
    </button>
  </form>
</div>
    <div class="bg-white p-8 rounded-[2rem] border-2 border-slate-100 shadow-sm mt-8">
        <h2 class="text-xl font-black uppercase italic text-slate-800 mb-6">Point Multipliers</h2>
        
        <form method="POST" class="grid grid-cols-2 gap-6">
            <input type="hidden" name="action" value="update_multipliers" />

            {[1, 2, 3, 4].map(num => (
            <div class="flex flex-col gap-2">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Rank #{num} Bonus</label>
                <div class="relative">
                <input 
                    type="number" 
                    name={`multiplier_rank_${num}`} 
                    step="0.1" 
                    value={getSetting(`multiplier_rank_${num}`)}
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 font-black text-slate-800 focus:border-pink-500 outline-none transition-all"
                />
                <span class="absolute right-4 top-4 text-slate-300 font-bold">x</span>
                </div>
            </div>
            ))}
            
            <button type="submit" class="col-span-2 bg-slate-900 text-white font-black py-4 rounded-2xl uppercase tracking-widest hover:bg-pink-600 transition-all mt-4">
            Save Multipliers
            </button>
        </form>
        </div>

        <div class="bg-white rounded-[2.5rem] p-8 border-2 border-slate-100 shadow-sm mt-8">
  <h3 class="text-xl font-black uppercase italic mb-6">User Management</h3>
  <div class="divide-y divide-slate-100">
    {allUsers.map(u => (
      <div class="py-4 flex justify-between items-center">
        <div>
          <p class="font-bold text-slate-800">{u.username}</p>
          <p class="text-[10px] uppercase font-black text-slate-400">ID: {u.id}</p>
        </div>
        <form method="POST">
          <input type="hidden" name="action" value="toggle_user_status" />
          <input type="hidden" name="target_id" value={u.id} />
          <input type="hidden" name="current_status" value={u.is_active.toString()} />
          <button class={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${u.is_active ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
            {u.is_active ? '‚óè Active' : '‚óã Hidden'}
          </button>
        </form>
      </div>
    ))}
  </div>
</div>
  </div>
</MainLayout>

<script>
  document.getElementById('syncBtn').addEventListener('click', async () => {
    const ep = document.getElementById('epNumber').value;
    const status = document.getElementById('syncStatus');
    status.innerText = "Syncing...";
    
    const response = await fetch(`/api/sync-scores?episode=${ep}`, { method: 'POST' });
    const data = await response.json();
    
    if (data.success) {
      status.innerText = "‚úÖ Successfully synced and updated all leagues!";
      status.style.color = "#4ade80";
    } else {
      status.innerText = "‚ùå Sync failed. Check server logs.";
      status.style.color = "#f87171";
    }
  });
</script>
