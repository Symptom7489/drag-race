---
import MainLayout from '../../layouts/MainLayout.astro';
import { sql } from '../../lib/db';

const userId = Astro.cookies.get("userId")?.value;
const user = await sql`SELECT username FROM users WHERE id = ${userId}`;

// 1. Security Gate
if (!user[0] || user[0].username !== 'CrewChief') {
  return Astro.redirect('/dashboard');
}

// 2. Handle POST Actions
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");

  if (action === "update_multipliers") {
    const keys = ['multiplier_rank_1', 'multiplier_rank_2', 'multiplier_rank_3', 'multiplier_rank_4'];
    for (const key of keys) {
      const val = formData.get(key)?.toString();
      if (val) {
        await sql`INSERT INTO settings (key, value) VALUES (${key}, ${val}) ON CONFLICT (key) DO UPDATE SET value = ${val}`;
      }
    }
  }

  if (action === "update_episode") {
    const newEp = formData.get("current_episode");
    await sql`UPDATE settings SET value = ${newEp} WHERE key = 'current_episode'`;
  }

  if (action === "toggle_lock") {
    const ep = formData.get("episode");
    const isCurrentlyLocked = formData.get("currentState") === 'true';
    const newState = isCurrentlyLocked ? 'false' : 'true';
    await sql`INSERT INTO settings (key, value) VALUES (${`locked_ep_${ep}`}, ${newState}) ON CONFLICT (key) DO UPDATE SET value = ${newState}`;
  }

  if (action === "recalculate_scores") {
    const multRows = await sql`SELECT * FROM settings WHERE key LIKE 'multiplier_rank_%'`;
    const mults = {
      1: parseFloat(multRows.find(s => s.key === 'multiplier_rank_1')?.value || "2.0"),
      2: parseFloat(multRows.find(s => s.key === 'multiplier_rank_2')?.value || "1.5"),
      3: parseFloat(multRows.find(s => s.key === 'multiplier_rank_3')?.value || "1.0"),
      4: parseFloat(multRows.find(s => s.key === 'multiplier_rank_4')?.value || "0.5"),
    };

    const allPoints = await sql`
      SELECT r.user_id, lm.league_id, r.rank, COALESCE(SUM(qbs.points), 0) as raw_points
      FROM rosters r
      JOIN league_members lm ON r.user_id = lm.user_id
      LEFT JOIN queen_box_scores qbs ON r.queen_name = qbs.queen_name AND r.episode_number = qbs.episode_number
      GROUP BY r.user_id, lm.league_id, r.rank
    `;

    await sql`DELETE FROM user_queen_scores`;
    await sql`DELETE FROM league_standings`;

    for (const row of allPoints) {
      const weighted = parseFloat(row.raw_points) * (mults[row.rank] || 1.0);
      await sql`INSERT INTO user_queen_scores (league_id, user_id, rank, calculated_points) VALUES (${row.league_id}, ${row.user_id}, ${row.rank}, ${weighted})`;
    }

    await sql`INSERT INTO league_standings (league_id, user_id, total_score) SELECT league_id, user_id, SUM(calculated_points) FROM user_queen_scores GROUP BY league_id, user_id`;
    
    console.log("Global scores updated for all users!");
  }
} // <--- THIS WAS THE MISSING BRACE

// 3. Fetch Data for UI (Always runs)
const settingsRows = await sql`SELECT * FROM settings`;
const settings = Object.fromEntries(settingsRows.map(r => [r.key, r.value]));
const currentEp = parseInt(settings.current_episode || "1");

const getSetting = (key) => settings[key] || "1.0";
const isLocked = (ep) => settings[`locked_ep_${ep}`] === 'true';
---

<MainLayout title="Admin Settings">
  <div class="max-w-4xl mx-auto py-10 px-4">
    <div class="mb-10">
      <h1 class="text-4xl font-black italic uppercase text-slate-900">League Control Center</h1>
      <p class="text-slate-500 font-bold uppercase tracking-widest text-xs text-left">Manage Season Flow & Locks</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      
      <div class="bg-white p-8 rounded-[2.5rem] border-2 border-slate-100 shadow-sm">
        <div class="mb-6">
          <h2 class="text-xl font-black uppercase italic text-slate-800">Global Episode</h2>
          <p class="text-sm text-slate-500">Sets the default week for the entire site.</p>
        </div>
        
        <form method="POST" class="flex items-center gap-4">
          <input type="hidden" name="action" value="update_episode" />
          <input 
            type="number" 
            name="current_episode" 
            value={currentEp} 
            class="w-full p-4 bg-slate-50 rounded-2xl border-none font-black text-2xl text-center focus:ring-2 focus:ring-pink-500"
          />
          <button class="bg-slate-900 text-white font-black px-6 py-4 rounded-2xl uppercase text-xs hover:bg-slate-800 transition-all">
            Update
          </button>
        </form>
      </div>

      <div class="bg-pink-600 p-8 rounded-[2.5rem] text-white shadow-xl shadow-pink-200">
        <h2 class="text-xl font-black uppercase italic mb-2">System Status</h2>
        <div class="space-y-4 mt-6">
          <div class="flex justify-between items-center border-b border-pink-500 pb-2">
            <span class="text-xs font-bold uppercase opacity-80">Drafting Status</span>
            <span class="font-black uppercase">{isLocked(currentEp) ? 'ðŸ”´ Locked' : 'ðŸŸ¢ Open'}</span>
          </div>
          <div class="flex justify-between items-center border-b border-pink-500 pb-2">
            <span class="text-xs font-bold uppercase opacity-80">Active Week</span>
            <span class="font-black uppercase italic">Episode {currentEp}</span>
          </div>
        </div>
      </div>

    </div>

    <div class="mt-12">
      <h2 class="text-2xl font-black uppercase italic text-slate-900 mb-6">Episode Locks</h2>
      <div class="bg-white rounded-[2.5rem] border-2 border-slate-100 overflow-hidden">
        <table class="w-full text-left">
          <thead class="bg-slate-50 border-b border-slate-100">
            <tr>
              <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400">Episode</th>
              <th class="px-6 py-4 text-[10px] font-black uppercase text-slate-400">Draft Status</th>
              <th class="px-6 py-4 text-right"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-50">
            {[1,2,3,4,5,6,7,8].map(ep => (
              <tr>
                <td class="px-6 py-4 font-black text-slate-700">Episode {ep}</td>
                <td class="px-6 py-4">
                  <span class={`text-[10px] font-black uppercase px-3 py-1 rounded-full ${isLocked(ep) ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                    {isLocked(ep) ? 'Locked' : 'Open'}
                  </span>
                </td>
                <td class="px-6 py-4 text-right">
                  <form method="POST">
                    <input type="hidden" name="action" value="toggle_lock" />
                    <input type="hidden" name="episode" value={ep} />
                    <input type="hidden" name="currentState" value={isLocked(ep) ? 'true' : 'false'} />
                    <button class="text-[10px] font-black uppercase text-slate-400 hover:text-pink-600 transition-colors">
                      {isLocked(ep) ? 'Unlock' : 'Lock'}
                    </button>
                  </form>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
    <div class="bg-white p-8 rounded-[2rem] border-2 border-slate-100 mt-8">
  <h2 class="text-xl font-black uppercase italic mb-2 text-slate-900">Season Engine</h2>
  <p class="text-slate-500 text-xs mb-6 font-bold uppercase">Update all league leaderboards with the latest points and multipliers.</p>
  
  <form method="POST">
    <input type="hidden" name="action" value="recalculate_scores" />
    <button type="submit" class="w-full bg-pink-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-pink-200 hover:scale-[1.02] active:scale-95 transition-all">
      ðŸ”„ RECALCULATE ALL STANDINGS
    </button>
  </form>
</div>
    <div class="bg-white p-8 rounded-[2rem] border-2 border-slate-100 shadow-sm mt-8">
        <h2 class="text-xl font-black uppercase italic text-slate-800 mb-6">Point Multipliers</h2>
        
        <form method="POST" class="grid grid-cols-2 gap-6">
            <input type="hidden" name="action" value="update_multipliers" />

            {[1, 2, 3, 4].map(num => (
            <div class="flex flex-col gap-2">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Rank #{num} Bonus</label>
                <div class="relative">
                <input 
                    type="number" 
                    name={`multiplier_rank_${num}`} 
                    step="0.1" 
                    value={getSetting(`multiplier_rank_${num}`)}
                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 font-black text-slate-800 focus:border-pink-500 outline-none transition-all"
                />
                <span class="absolute right-4 top-4 text-slate-300 font-bold">x</span>
                </div>
            </div>
            ))}
            
            <button type="submit" class="col-span-2 bg-slate-900 text-white font-black py-4 rounded-2xl uppercase tracking-widest hover:bg-pink-600 transition-all mt-4">
            Save Multipliers
            </button>
        </form>
        </div>
  </div>
</MainLayout>