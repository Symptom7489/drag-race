---
import MainLayout from '../layouts/MainLayout.astro';
import { sql } from '../lib/db';

const settings = await sql`SELECT value FROM settings WHERE key = 'current_episode'`;
const currentEp = parseInt(settings[0].value);

const rankings = await sql`
  WITH latest_rosters AS (
    SELECT DISTINCT ON (user_id, rank) user_id, queen_name
    FROM rosters
    WHERE episode_number <= ${currentEp}
    ORDER BY user_id, rank, episode_number DESC
  ),
  player_totals AS (
    SELECT 
      u.id as user_id,
      u.username,
      COALESCE(SUM(qbs.points), 0) as total_score
    FROM users u
    JOIN latest_rosters lr ON u.id = lr.user_id
    LEFT JOIN queen_box_scores qbs ON lr.queen_name = qbs.queen_name
    GROUP BY u.id, u.username
  ),
  mvps AS (
    SELECT DISTINCT ON (lr.user_id)
      lr.user_id,
      lr.queen_name as mvp_queen,
      SUM(qbs.points) as queen_pts
    FROM latest_rosters lr
    JOIN queen_box_scores qbs ON lr.queen_name = qbs.queen_name
    GROUP BY lr.user_id, lr.queen_name
    ORDER BY lr.user_id, SUM(qbs.points) DESC
  )
  SELECT 
    pt.*,
    mvps.mvp_queen
  FROM player_totals pt
  LEFT JOIN mvps ON pt.user_id = mvps.user_id
  ORDER BY pt.total_score DESC;
`;

const podium = rankings.slice(0, 3);
const theRest = rankings.slice(3);
---

<MainLayout title="Leaderboard">
  <div class="max-w-5xl mx-auto py-12 px-4">
    
    <div class="text-center mb-16">
      <h1 class="text-7xl font-black italic uppercase tracking-tighter text-slate-900 mb-2">The Rankings</h1>
      <p class="text-pink-600 font-black uppercase tracking-[0.3em] text-sm">Season 18 â€¢ Official Standings</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end mb-16">
      {podium.map((player, i) => (
        <div class={`relative flex flex-col items-center ${i === 0 ? 'order-2' : i === 1 ? 'order-1' : 'order-3'}`}>
          {/* Rank Badge */}
          <div class={`absolute -top-6 w-12 h-12 rounded-full flex items-center justify-center font-black text-xl shadow-xl z-10 ${i === 0 ? 'bg-yellow-400 text-yellow-900 scale-125' : 'bg-slate-200 text-slate-600'}`}>
            {i + 1}
          </div>
          
          <div class={`w-full bg-white rounded-t-[3rem] p-8 pb-12 shadow-2xl border-x-4 border-t-4 flex flex-col items-center transition-transform hover:-translate-y-2 ${i === 0 ? 'h-80 border-yellow-400' : 'h-64 border-slate-100'}`}>
            <div class="text-center mb-4 mt-4">
              <p class="text-xs font-black uppercase tracking-widest text-slate-400 mb-1">Player</p>
              <h2 class="text-2xl font-black uppercase italic leading-tight text-slate-900">{player.username}</h2>
            </div>
            
            <div class="mt-auto text-center">
              <span class="text-4xl font-black text-slate-900">{player.total_score}</span>
              <p class="text-[10px] font-black uppercase tracking-widest text-pink-500">Points</p>
            </div>
          </div>
          
          <div class="w-full bg-slate-900 text-center py-3 rounded-b-2xl">
             <p class="text-[9px] font-black text-slate-500 uppercase">Team MVP</p>
             <p class="text-xs font-bold text-white uppercase italic">{player.mvp_queen}</p>
          </div>
        </div>
      ))}
    </div>

    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
      <div class="p-6 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
        <h3 class="font-black uppercase tracking-widest text-xs text-slate-400">The Rest of the Pack</h3>
        <span class="text-[10px] font-bold text-slate-400 uppercase">Total Score</span>
      </div>
      
      <div class="divide-y divide-slate-100">
        {theRest.map((player, index) => (
          <div class="p-6 flex justify-between items-center hover:bg-slate-50 transition-colors group">
            <div class="flex items-center gap-6">
              <span class="font-black text-slate-200 text-2xl group-hover:text-pink-200 transition-colors">#{index + 4}</span>
              <div>
                <p class="font-black text-lg text-slate-800 uppercase italic tracking-tight">{player.username}</p>
                <p class="text-[10px] font-bold text-slate-400 uppercase">MVP: {player.mvp_queen}</p>
              </div>
            </div>
            <div class="bg-slate-900 text-white font-black px-6 py-2 rounded-xl text-xl">
              {player.total_score}
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
</MainLayout>